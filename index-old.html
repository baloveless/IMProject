<!DOCTYPE html>
<html>
   <head>
	   <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <meta http-equiv="X-UA-Compatible" content="ie=edge" />
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
      <title>IMProject</title>
      <style>
        #message-container{height:300px;overflow: auto;}
      </style>
   </head>
   <script src = "/socket.io/socket.io.js"></script> 
   <script>
      var socket = io();
      var user;

      // sends login request
      function setUsername() {
         var name = document.getElementById('name').value
         if (name === '')
            document.getElementById('error-container').innerHTML = '<p>Please Enter a Name</p>';
         else  
            socket.emit('setUsername', name);
      }

      function createAccount() {
         var name = document.getElementById('name').value
         if (name === '')
            document.getElementById('error-container').innerHTML = '<p>Please Enter a Name</p>';
         else  
            socket.emit('createUser', name);
      }

      // failed login
      socket.on('Error', function(data) {
         document.getElementById('error-container').innerHTML = data;
      });

      // login successful, show all chats1
      socket.on('userSet', function(data) {
         user = data.username;
         chatList();
      });

      function logout(){
         socket.emit('logout');
      }

      // changes html to show the chats the current user has saved, then requests 
      // the list of chats from the server. 
      function chatList(){
         document.body.innerHTML = '<div class="container"><div class="row"><div class="col-12 col-md-8"><h1 class="text-center">Chat Rooms</h1><p class="text-center">Please Choose a chat</p>\<div id = "error-container"></div></div></div><div class="row"><div class="col"><button type = "button" name = "button" onclick = "createChat()" class = "btn btn-primary btn-lg">New Chat</button></div><div class="col"><button type = "button" name = "button" onclick = "logout()" class = "btn btn-danger btn-lg">Logout</button></div></div><br/><div class="row"><div class="col-12 col-md-8"><div id = "chat-container"></div></div><div class="col-6 col-md-4"><div id = "delete-container"></div></div></div></div>';
         socket.emit('getchats');
      }

      // changes html to show form for creating new chat. 
      function createChat(){
         document.body.innerHTML = '<div class="container"><div class="row"><div class="col-md-6 offset-md-3 col-sm-12"><h1 class="text-center">Create New Chat Room</h1><p>Please enter the usernames of those you want in the chat separate by commas</p>\<div id = "error-container"></div>\<input type = "text" id = "users" class = "form-control" placeholder = "Harry, Hank, etc.">\<button type = "button" name = "button" onclick = "makeNewRoom()" class = "btn btn-primary btn-lg btn-block">Create</button>\<br/><button type = "button" name = "button" onclick = "chatList()"class = "btn btn-secondary btn-lg btn-block">back</button>\</div></div></div>';
      }

      // emits a list of users to add to new chat
      function makeNewRoom(){
        var users;
        var str = document.getElementById('users').value;
        t += ', ' + user;
        var t = str.split(",");
        socket.emit('newRoom', t);
      }

      socket.on('chatlist', function(chats, ids){
         console.log('Chat list received: ' + ids);
         if (chats){
               for (var x = 0; x < ids.length; x++) {
                  document.getElementById('chat-container').innerHTML += '<button type = "button" id = "'+ x +'" name = "button'+ x +'" onclick = "enterRoom(\'' + ids[x] +'\')" class = "btn btn-secondary btn-lg btn-block">' + chats[x] +'</button><br/>';
                  document.getElementById('delete-container').innerHTML += '<button type = "button" name = "button'+ x +'del" onclick = "deleteRoom(\'' + ids[x] +'\')" class = "btn btn-danger btn-lg">Delete ' + chats[x] +'</button><br/><br/>';
               }
         } else  {
            document.getElementById('chat-container').innerHTML += '<div><b>No Chats to show<\b><\div>';
         }
      });

      // emits chat rooms id
      function enterRoom(id) {
         socket.emit('chooseRoom',  id);
      }

      function deleteRoom(id) {
         socket.emit('deleteRoom', id);
      }


      socket.on('enterRoom', function(msgs, users) {
         document.body.innerHTML = '<div class="container"><div class="row"><div class="col-md-6 offset-md-3 col-sm-12"><h1 class="text-center">Chat Room</h1>\<div id = "error-container"></div>\<br><button type = "button" name = "button" class="btn btn-danger btn-block" onclick = "chatList()">Chats</button>\<br>\<div class = "card"><div id = "message-container" class = "card-block"></div></div><br/>\<input type = "text" id = "message" class = "form-control">\<br/><button type = "button" name = "button" onclick = "sendMessage()" class= "btn btn-primary btn-block">Send</button>	</div></div></div>';
         if (msgs){
           for (var x = 0; x < msgs.length; x++){
            var message = document.createElement('div');
            message.setAttribute('class', 'chat-message');
            message.textContent =  users[x]+ ": "+msgs[x];
            var messages = document.getElementById('message-container');
            messages.appendChild(message);
            messages.insertBefore(message, messages.firstChild);
           } 
         }
      });

      function sendMessage() {
         var msg = document.getElementById('message').value;
         if(msg) {
            socket.emit('msg', {message: msg, user: user});
			   document.getElementById('message').value = '';
         }
      }

      socket.on('newmsg', function(data) {
         if(user) {
            var message = document.createElement('div');
            message.setAttribute('class', 'chat-message');
            message.textContent = data.user + ": " +data.message;
            var messages = document.getElementById('message-container');
            messages.appendChild(message);
            messages.insertBefore(message, messages.firstChild);
         }
      });

      socket.on('noRoom', () => {
         chatList();
      });

      socket.on('chatListUpdate', () => {
         chatList();
      })


      // action is attempted without socket knowing user, its a copy of the below code.  
      socket.on('noUser', () => {
         document.body.innerHTML = '<div class="container"><div class="row"><div class="col-md-6 offset-md-3 col-sm-12"><h1 class="text-center">IM Login</h1><p class="text=center">Please enter your username and password</p><div id = "error-container"></div><input id = "name" class="form-control" type = "text" name = "name" value = "" placeholder = "Enter your name!"><br/><button type = "button" class="btn btn-primary btn-block" name = "button" onclick = "setUsername()">Login</button><br/><button type = "button" class="btn btn-secondary btn-block" name = "button" onclick = "createAccount()">Create Account</button></div></div></div>'
      });
   </script>
   
   <body>
			<div class="container">
      	<div class="row">
        	<div class="col-md-6 offset-md-3 col-sm-12">
          	<h1 class="text-center">IM Login</h1>
          	<p class="text=center">Please enter your username and password</p>
            <div id = "error-container"></div>
					<input id = "name" class="form-control" type = "text" name = "name" value = "" placeholder = "Enter your name!">
               <br/>
      			<button type = "button" class="btn btn-primary btn-block" name = "button" onclick = "setUsername()">Login</button>
               <br/>
      			<button type = "button" class="btn btn-secondary btn-block" name = "button" onclick = "createAccount()">Create Account</button>
      		</div>
      	</div>
    	</div>

      
   </body>
</html>